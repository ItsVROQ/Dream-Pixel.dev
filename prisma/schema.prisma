generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserTier {
  FREE
  PRO
  ENTERPRISE
}

enum GenerationStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
}

enum SeedCategory {
  PORTRAIT
  LANDSCAPE
  ANIME
  ABSTRACT
  OTHER
}

enum SubscriptionStatus {
  INACTIVE
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String?
  passwordHash      String?  @map("password_hash")
  profilePictureUrl String?  @map("profile_picture_url")
  tier              UserTier @default(FREE)
  apiKey            String?  @unique @map("api_key")
  creditsRemaining  Int      @default(0) @map("credits_remaining")
  
  // Authentication fields
  emailVerified     DateTime? @map("email_verified")
  verificationToken String?   @map("verification_token")
  resetToken        String?   @map("reset_token")
  resetTokenExpiry  DateTime? @map("reset_token_expiry")
  failedLoginAttempts Int     @default(0) @map("failed_login_attempts")
  lockoutUntil      DateTime? @map("lockout_until")
  
  // OAuth fields
  accounts Account[]
  sessions Session[]
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  generations  Generation[]
  seeds        Seed[]        @relation("SeedCreator")
  subscription Subscription?

  @@index([createdAt], map: "users_created_at_idx")
  @@index([email], map: "users_email_idx")
  @@map("users")
}

model Generation {
  id                String           @id @default(cuid())
  userId            String           @map("user_id")
  prompt            String
  negativePrompt    String?          @map("negative_prompt")
  seed              Int?
  referenceImageUrl String?          @map("reference_image_url")
  resultImageUrl    String?          @map("result_image_url")
  settings          Json
  status            GenerationStatus @default(PENDING)
  errorMessage      String?          @map("error_message")
  processingTimeMs  Int?             @map("processing_time_ms")
  provider          String?          @default("gemini")
  jobId             String?          @map("job_id")
  retryCount        Int              @default(0) @map("retry_count")
  lastRetryAt       DateTime?        @map("last_retry_at")
  completedAt       DateTime?        @map("completed_at")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "generations_user_id_idx")
  @@index([seed], map: "generations_seed_idx")
  @@index([createdAt], map: "generations_created_at_idx")
  @@index([status], map: "generations_status_idx")
  @@index([jobId], map: "generations_job_id_idx")
  @@map("generations")
}

model Seed {
  id            String       @id @default(cuid())
  seedNumber    Int          @unique @map("seed_number")
  creatorId     String       @map("creator_id")
  title         String
  description   String?
  category      SeedCategory
  exampleImages String[]     @map("example_images")
  useCount      Int          @default(0) @map("use_count")
  likeCount     Int          @default(0) @map("like_count")
  isFeatured    Boolean      @default(false) @map("is_featured")
  createdAt     DateTime     @default(now()) @map("created_at")

  creator User @relation("SeedCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId], map: "seeds_creator_id_idx")
  @@index([createdAt], map: "seeds_created_at_idx")
  @@map("seeds")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique @map("user_id")
  stripeCustomerId     String?            @unique @map("stripe_customer_id")
  stripeSubscriptionId String?            @unique @map("stripe_subscription_id")
  status               SubscriptionStatus @default(INACTIVE)
  currentPeriodStart   DateTime?          @map("current_period_start")
  currentPeriodEnd     DateTime?          @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status], map: "subscriptions_status_idx")
  @@map("subscriptions")
}

// NextAuth.js models
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @map("refresh_token")
  access_token      String? @map("access_token")
  expires_at        Int?    @map("expires_at")
  token_type        String? @map("token_type")
  scope             String?
  id_token          String? @map("id_token")
  session_state     String? @map("session_state")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId], map: "accounts_user_id_idx")
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "sessions_user_id_idx")
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}
