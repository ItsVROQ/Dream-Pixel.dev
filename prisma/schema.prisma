generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserTier {
  FREE
  PRO
  ENTERPRISE
}

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum GenerationStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
}

enum SeedCategory {
  PORTRAIT
  LANDSCAPE
  ANIME
  ABSTRACT
  OTHER
}

enum SubscriptionStatus {
  INACTIVE
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
}

enum ImageType {
  REFERENCE
  GENERATION
  THUMBNAIL
  MEDIUM
  FULL
}

enum ImageStatus {
  UPLOADED
  PROCESSING
  PROCESSED
  FAILED
  DELETED
}

model User {
  id                String     @id @default(cuid())
  email             String     @unique
  name              String?
  passwordHash      String?    @map("password_hash")
  profilePictureUrl String?    @map("profile_picture_url")
  tier              UserTier   @default(FREE)
  role              UserRole   @default(USER)
  status            UserStatus @default(ACTIVE)
  apiKey            String?    @unique @map("api_key")
  creditsRemaining  Int        @default(0) @map("credits_remaining")
  lastActiveAt      DateTime?  @map("last_active_at")
  
  // Authentication fields
  emailVerified     DateTime? @map("email_verified")
  verificationToken String?   @map("verification_token")
  resetToken        String?   @map("reset_token")
  resetTokenExpiry  DateTime? @map("reset_token_expiry")
  failedLoginAttempts Int     @default(0) @map("failed_login_attempts")
  lockoutUntil      DateTime? @map("lockout_until")
  
  // OAuth fields
  accounts Account[]
  sessions Session[]
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  generations  Generation[]
  images       Image[]
  seeds        Seed[]        @relation("SeedCreator")
  subscription Subscription?
  apiKeys      ApiKey[]
  webhooks     Webhook[]
  invoices     Invoice[]

  @@index([createdAt], map: "users_created_at_idx")
  @@index([email], map: "users_email_idx")
  @@map("users")
}

model Image {
  id             String      @id @default(cuid())
  userId         String      @map("user_id")
  type           ImageType   @map("image_type")
  status         ImageStatus @default(UPLOADED)
  originalName   String      @map("original_name")
  originalSize   Int         @map("original_size")
  originalWidth  Int         @map("original_width")
  originalHeight Int         @map("original_height")
  s3Key          String      @map("s3_key")
  s3Bucket       String      @map("s3_bucket")
  url            String
  thumbnailUrl   String?     @map("thumbnail_url")
  mediumUrl      String?     @map("medium_url")
  fullUrl        String?     @map("full_url")
  hash           String?     @unique
  metadata       Json?
  expiryDate     DateTime?   @map("expiry_date")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  generations        Generation[] @relation("GenerationReferenceImage")
  resultGenerations  Generation[] @relation("GenerationResultImage")

  @@index([userId], map: "images_user_id_idx")
  @@index([type], map: "images_type_idx")
  @@index([status], map: "images_status_idx")
  @@index([createdAt], map: "images_created_at_idx")
  @@index([expiryDate], map: "images_expiry_date_idx")
  @@map("images")
}

model Generation {
  id                String           @id @default(cuid())
  userId            String           @map("user_id")
  prompt            String
  negativePrompt    String?          @map("negative_prompt")
  seed              Int?
  referenceImageId  String?          @map("reference_image_id")
  referenceImageUrl String?          @map("reference_image_url") @db.Text
  resultImageId     String?          @map("result_image_id")
  settings          Json
  status            GenerationStatus @default(PENDING)
  errorMessage      String?          @map("error_message")
  processingTimeMs  Int?             @map("processing_time_ms")
  provider          String?          @default("gemini")
  jobId             String?          @map("job_id")
  retryCount        Int              @default(0) @map("retry_count")
  lastRetryAt       DateTime?        @map("last_retry_at")
  completedAt       DateTime?        @map("completed_at")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  referenceImage  Image?          @relation("GenerationReferenceImage", fields: [referenceImageId], references: [id])
  resultImage     Image?          @relation("GenerationResultImage", fields: [resultImageId], references: [id])

  @@index([userId], map: "generations_user_id_idx")
  @@index([seed], map: "generations_seed_idx")
  @@index([createdAt], map: "generations_created_at_idx")
  @@index([status], map: "generations_status_idx")
  @@index([jobId], map: "generations_job_id_idx")
  @@index([referenceImageId], map: "generations_reference_image_id_idx")
  @@map("generations")
}

model Seed {
  id            String       @id @default(cuid())
  seedNumber    Int          @unique @map("seed_number")
  creatorId     String       @map("creator_id")
  title         String
  description   String?
  category      SeedCategory
  exampleImages String[]     @map("example_images")
  useCount      Int          @default(0) @map("use_count")
  likeCount     Int          @default(0) @map("like_count")
  isFeatured    Boolean      @default(false) @map("is_featured")
  isApproved    Boolean      @default(false) @map("is_approved")
  isBanned      Boolean      @default(false) @map("is_banned")
  createdAt     DateTime     @default(now()) @map("created_at")

  creator User @relation("SeedCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId], map: "seeds_creator_id_idx")
  @@index([createdAt], map: "seeds_created_at_idx")
  @@map("seeds")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique @map("user_id")
  stripeCustomerId     String?            @unique @map("stripe_customer_id")
  stripeSubscriptionId String?            @unique @map("stripe_subscription_id")
  stripePriceId        String?            @map("stripe_price_id")
  billingPeriod        String?            @map("billing_period")
  status               SubscriptionStatus @default(INACTIVE)
  currentPeriodStart   DateTime?          @map("current_period_start")
  currentPeriodEnd     DateTime?          @map("current_period_end")
  cancelAt             DateTime?          @map("cancel_at")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  generationLimit      Int?               @map("generation_limit")
  usageWarningSentAt   DateTime?          @map("usage_warning_sent_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status], map: "subscriptions_status_idx")
  @@map("subscriptions")
}

model Invoice {
  id                   String   @id @default(cuid())
  userId               String   @map("user_id")
  stripeInvoiceId      String   @unique @map("stripe_invoice_id")
  stripeCustomerId     String?  @map("stripe_customer_id")
  stripeSubscriptionId String?  @map("stripe_subscription_id")
  number               String?
  status               String?
  amountPaid           Int      @default(0) @map("amount_paid")
  currency             String   @default("usd")
  hostedInvoiceUrl     String?  @map("hosted_invoice_url")
  pdfUrl               String?  @map("pdf_url")
  s3Key                String?  @map("s3_key")
  createdAt            DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "invoices_user_id_idx")
  @@map("invoices")
}

model StripeEvent {
  id              String   @id @map("id")
  type            String
  stripeCreatedAt DateTime? @map("stripe_created_at")
  processedAt     DateTime @default(now()) @map("processed_at")

  @@index([type], map: "stripe_events_type_idx")
  @@map("stripe_events")
}

// NextAuth.js models
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @map("refresh_token")
  access_token      String? @map("access_token")
  expires_at        Int?    @map("expires_at")
  token_type        String? @map("token_type")
  scope             String?
  id_token          String? @map("id_token")
  session_state     String? @map("session_state")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId], map: "accounts_user_id_idx")
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "sessions_user_id_idx")
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model ApiKey {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  name      String?
  keyPrefix String    @map("key_prefix")
  keyHash   String    @unique @map("key_hash")
  type      String    @default("live") // live or test
  createdAt DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")
  revokedAt DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("api_keys")
}

model Webhook {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  url       String
  events    String[] // e.g. ["generation.completed", "generation.failed"]
  secret    String   // For HMAC signature
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs WebhookLog[]

  @@index([userId])
  @@map("webhooks")
}

model WebhookLog {
  id        String   @id @default(cuid())
  webhookId String   @map("webhook_id")
  eventId   String   @map("event_id")
  eventType String   @map("event_type")
  payload   Json
  statusCode Int?    @map("status_code")
  response  String?
  error     String?
  attempt   Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@map("webhook_logs")
model ErrorLog {
  id        String   @id @default(cuid())
  level     String   // ERROR, WARN, INFO
  message   String
  stack     String?
  metadata  Json?
  userId    String?  @map("user_id")
  endpoint  String?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([createdAt], map: "error_logs_created_at_idx")
  @@index([level], map: "error_logs_level_idx")
  @@map("error_logs")
}
