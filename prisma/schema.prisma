generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserTier {
  FREE
  PRO
  ENTERPRISE
}

enum GenerationStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
}

enum SeedCategory {
  PORTRAIT
  LANDSCAPE
  ANIME
  ABSTRACT
  OTHER
}

enum SubscriptionStatus {
  INACTIVE
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
}

enum ImageType {
  REFERENCE
  GENERATION
  THUMBNAIL
  MEDIUM
  FULL
}

enum ImageStatus {
  UPLOADED
  PROCESSING
  PROCESSED
  FAILED
  DELETED
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String?
  passwordHash      String   @map("password_hash")
  profilePictureUrl String?  @map("profile_picture_url")
  tier              UserTier @default(FREE)
  apiKey            String?  @unique @map("api_key")
  creditsRemaining  Int      @default(0) @map("credits_remaining")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  generations  Generation[]
  images       Image[]
  seeds        Seed[]        @relation("SeedCreator")
  subscription Subscription?

  @@index([createdAt], map: "users_created_at_idx")
  @@map("users")
}

model Image {
  id             String      @id @default(cuid())
  userId         String      @map("user_id")
  type           ImageType   @map("image_type")
  status         ImageStatus @default(UPLOADED)
  originalName   String      @map("original_name")
  originalSize   Int         @map("original_size")
  originalWidth  Int         @map("original_width")
  originalHeight Int         @map("original_height")
  s3Key          String      @map("s3_key")
  s3Bucket       String      @map("s3_bucket")
  url            String
  thumbnailUrl   String?     @map("thumbnail_url")
  mediumUrl      String?     @map("medium_url")
  fullUrl        String?     @map("full_url")
  hash           String?     @unique
  metadata       Json?
  expiryDate     DateTime?   @map("expiry_date")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  generations        Generation[] @relation("GenerationReferenceImage")
  resultGenerations  Generation[] @relation("GenerationResultImage")

  @@index([userId], map: "images_user_id_idx")
  @@index([type], map: "images_type_idx")
  @@index([status], map: "images_status_idx")
  @@index([createdAt], map: "images_created_at_idx")
  @@index([expiryDate], map: "images_expiry_date_idx")
  @@map("images")
}

model Generation {
  id                String           @id @default(cuid())
  userId            String           @map("user_id")
  prompt            String
  negativePrompt    String?          @map("negative_prompt")
  seed              Int?
  referenceImageId  String?          @map("reference_image_id")
  referenceImageUrl String?          @map("reference_image_url") @db.Text
  resultImageId     String?          @map("result_image_id")
  settings          Json
  status            GenerationStatus @default(PENDING)
  errorMessage      String?          @map("error_message")
  processingTimeMs  Int?             @map("processing_time_ms")
  createdAt         DateTime         @default(now()) @map("created_at")

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  referenceImage  Image?          @relation("GenerationReferenceImage", fields: [referenceImageId], references: [id])
  resultImage     Image?          @relation("GenerationResultImage", fields: [resultImageId], references: [id])

  @@index([userId], map: "generations_user_id_idx")
  @@index([seed], map: "generations_seed_idx")
  @@index([createdAt], map: "generations_created_at_idx")
  @@index([status], map: "generations_status_idx")
  @@index([referenceImageId], map: "generations_reference_image_id_idx")
  @@map("generations")
}

model Seed {
  id            String       @id @default(cuid())
  seedNumber    Int          @unique @map("seed_number")
  creatorId     String       @map("creator_id")
  title         String
  description   String?
  category      SeedCategory
  exampleImages String[]     @map("example_images")
  useCount      Int          @default(0) @map("use_count")
  likeCount     Int          @default(0) @map("like_count")
  isFeatured    Boolean      @default(false) @map("is_featured")
  createdAt     DateTime     @default(now()) @map("created_at")

  creator User @relation("SeedCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId], map: "seeds_creator_id_idx")
  @@index([createdAt], map: "seeds_created_at_idx")
  @@map("seeds")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique @map("user_id")
  stripeCustomerId     String?            @unique @map("stripe_customer_id")
  stripeSubscriptionId String?            @unique @map("stripe_subscription_id")
  status               SubscriptionStatus @default(INACTIVE)
  currentPeriodStart   DateTime?          @map("current_period_start")
  currentPeriodEnd     DateTime?          @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status], map: "subscriptions_status_idx")
  @@map("subscriptions")
}
